<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>04. Train pseudoinverse solution + CNN denoising &mdash; spyrit 2.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/sg_README.css?v=78231cbc" />


  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->

        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=20623aea"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="05. Acquisition operators (advanced) - Split measurements and subsampling" href="tuto_05_acquisition_split_measurements.html" />
    <link rel="prev" title="03. Pseudoinverse solution + CNN denoising" href="tuto_03_pseudoinverse_cnn_linear.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >



          <a href="../index.html" class="icon icon-home">
            spyrit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Subpackages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/spyrit.core.html">spyrit.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/spyrit.misc.html">spyrit.misc</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tuto_01_acquisition_operators.html">01. Acquisition operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuto_02_pseudoinverse_linear.html">02. Pseudoinverse solution from linear measurements</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuto_03_pseudoinverse_cnn_linear.html">03. Pseudoinverse solution + CNN denoising</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">04. Train pseudoinverse solution + CNN denoising</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-a-batch-of-images">Load a batch of images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-a-dataloader">Define a dataloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-a-measurement-operator">Define a measurement operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pinvnet-network">PinvNet Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-a-loss-function-optimizer-and-scheduler">Define a Loss function optimizer and scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#train-the-network">Train the network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save-the-network-and-training-history">Save the network and training history</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tuto_05_acquisition_split_measurements.html">05. Acquisition operators (advanced) - Split measurements and subsampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuto_06_dcnet_split_measurements.html">06. DCNet solution for split measurements</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuto_bonus_advanced_methods_colab.html">Bonus. Advanced methods - Colab</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">spyrit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">04. Train pseudoinverse solution + CNN denoising</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/gallery/tuto_04_train_pseudoinverse_cnn_linear.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-gallery-tuto-04-train-pseudoinverse-cnn-linear-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="train-pseudoinverse-solution-cnn-denoising">
<span id="sphx-glr-gallery-tuto-04-train-pseudoinverse-cnn-linear-py"></span><h1>04. Train pseudoinverse solution + CNN denoising<a class="headerlink" href="#train-pseudoinverse-solution-cnn-denoising" title="Link to this heading"></a></h1>
<p id="tuto-train-pseudoinverse-cnn-linear">This tutorial shows how to train PinvNet with a CNN denoiser for
reconstruction of linear measurements (results shown in the
<a class="reference internal" href="tuto_03_pseudoinverse_cnn_linear.html#tuto-pseudoinverse-cnn-linear"><span class="std std-ref">previous tutorial</span></a>).
As an example, we use a small CNN, which can be replaced by any other network,
for example Unet. Training is performed on the STL-10 dataset.</p>
<p>You can use Tensorboard for Pytorch for experiment tracking and
for visualizing the training process: losses, network weights,
and intermediate results (reconstructed images at different epochs).</p>
<p>The linear measurement operator is chosen as the positive part of a Hadamard matrix,
but this matrix can be replaced by any desired matrix.</p>
<p>These tutorials load image samples from <cite>/images/</cite>.</p>
<section id="load-a-batch-of-images">
<h2>Load a batch of images<a class="headerlink" href="#load-a-batch-of-images" title="Link to this heading"></a></h2>
<p>First, we load an image <span class="math notranslate nohighlight">\(x\)</span> and normalized it to [-1,1], as in previous examples.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">spyrit.misc.disp</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.misc.disp.imagesc.html#spyrit.misc.disp.imagesc" title="spyrit.misc.disp.imagesc" class="sphx-glr-backref-module-spyrit-misc-disp sphx-glr-backref-type-py-function"><span class="n">imagesc</span></a>
<span class="kn">from</span> <span class="nn">spyrit.misc.statistics</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.misc.statistics.transform_gray_norm.html#spyrit.misc.statistics.transform_gray_norm" title="spyrit.misc.statistics.transform_gray_norm" class="sphx-glr-backref-module-spyrit-misc-statistics sphx-glr-backref-type-py-function"><span class="n">transform_gray_norm</span></a>

<span class="n">h</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># image size hxh</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Image index (modify to change the image)</span>
<span class="n">spyritPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">imgs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spyritPath</span><span class="p">,</span> <span class="s2">&quot;images/&quot;</span><span class="p">)</span>


<span class="c1"># Create a transform for natural images to normalized grayscale image tensors</span>
<span class="n">transform</span> <span class="o">=</span> <a href="../_autosummary/spyrit.misc.statistics.transform_gray_norm.html#spyrit.misc.statistics.transform_gray_norm" title="spyrit.misc.statistics.transform_gray_norm" class="sphx-glr-backref-module-spyrit-misc-statistics sphx-glr-backref-type-py-function"><span class="n">transform_gray_norm</span></a><span class="p">(</span><span class="n">img_size</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># Create dataset and loader (expects class folder &#39;images/test/&#39;)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">ImageFolder</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">imgs_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of input images: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Select image</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># plot</span>
<span class="n">x_plot</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a href="../_autosummary/spyrit.misc.disp.imagesc.html#spyrit.misc.disp.imagesc" title="spyrit.misc.disp.imagesc" class="sphx-glr-backref-module-spyrit-misc-disp sphx-glr-backref-type-py-function"><span class="n">imagesc</span></a><span class="p">(</span><span class="n">x_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="sa">r</span><span class="s2">&quot;$x$ in [-1, 1]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-a-dataloader">
<h2>Define a dataloader<a class="headerlink" href="#define-a-dataloader" title="Link to this heading"></a></h2>
<p>We define a dataloader for STL-10 dataset using <a class="reference internal" href="../_autosummary/spyrit.misc.statistics.data_loaders_stl10.html#spyrit.misc.statistics.data_loaders_stl10" title="spyrit.misc.statistics.data_loaders_stl10"><code class="xref py py-func docutils literal notranslate"><span class="pre">spyrit.misc.statistics.data_loaders_stl10()</span></code></a>.
This will download the dataset to the provided path if it is not already downloaded.
It is based on pytorch pre-loaded dataset <code class="xref py py-class docutils literal notranslate"><span class="pre">torchvision.datasets.STL10</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>, which creates a generator that iterates
through the dataset, returning a batch of images and labels at each iteration.</p>
<p>Set <code class="xref py py-attr docutils literal notranslate"><span class="pre">mode_run</span></code> to True in the script below to download the dataset and for training;
otherwise, pretrained weights and results will be download for display.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spyrit.misc.statistics</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.misc.statistics.data_loaders_stl10.html#spyrit.misc.statistics.data_loaders_stl10" title="spyrit.misc.statistics.data_loaders_stl10" class="sphx-glr-backref-module-spyrit-misc-statistics sphx-glr-backref-type-py-function"><span class="n">data_loaders_stl10</span></a>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Parameters</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># image size hxh</span>
<span class="n">data_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./data&quot;</span><span class="p">)</span>  <span class="c1"># path to data folder (where the dataset is stored)</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">512</span>

<span class="c1"># Dataloader for STL-10 dataset</span>
<span class="n">mode_run</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">mode_run</span><span class="p">:</span>
    <span class="n">dataloaders</span> <span class="o">=</span> <a href="../_autosummary/spyrit.misc.statistics.data_loaders_stl10.html#spyrit.misc.statistics.data_loaders_stl10" title="spyrit.misc.statistics.data_loaders_stl10" class="sphx-glr-backref-module-spyrit-misc-statistics sphx-glr-backref-type-py-function"><span class="n">data_loaders_stl10</span></a><span class="p">(</span>
        <span class="n">data_root</span><span class="p">,</span>
        <span class="n">img_size</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-a-measurement-operator">
<h2>Define a measurement operator<a class="headerlink" href="#define-a-measurement-operator" title="Link to this heading"></a></h2>
<p>We consider the case where the measurement matrix is the positive
component of a Hadamard matrix, which is often used in single-pixel imaging
(see <a class="reference internal" href="tuto_02_pseudoinverse_linear.html#hadamard-positive"><span class="std std-ref">Hadamard matrix</span></a>).
Then, we simulate an accelerated acquisition by keeping only the first
<code class="xref py py-attr docutils literal notranslate"><span class="pre">M</span></code> low-frequency coefficients (see <a class="reference internal" href="tuto_02_pseudoinverse_linear.html#low-frequency"><span class="std std-ref">low frequency sampling</span></a>).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">spyrit.misc.walsh_hadamard</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.misc.walsh_hadamard.walsh2_matrix.html#spyrit.misc.walsh_hadamard.walsh2_matrix" title="spyrit.misc.walsh_hadamard.walsh2_matrix" class="sphx-glr-backref-module-spyrit-misc-walsh_hadamard sphx-glr-backref-type-py-function"><span class="n">walsh2_matrix</span></a>
<span class="kn">from</span> <span class="nn">spyrit.misc.sampling</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.misc.sampling.Permutation_Matrix.html#spyrit.misc.sampling.Permutation_Matrix" title="spyrit.misc.sampling.Permutation_Matrix" class="sphx-glr-backref-module-spyrit-misc-sampling sphx-glr-backref-type-py-function"><span class="n">Permutation_Matrix</span></a>

<span class="n">und</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># undersampling factor</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">//</span> <span class="n">und</span>  <span class="c1"># number of measurements (undersampling factor = 4)</span>

<span class="n">F</span> <span class="o">=</span> <a href="../_autosummary/spyrit.misc.walsh_hadamard.walsh2_matrix.html#spyrit.misc.walsh_hadamard.walsh2_matrix" title="spyrit.misc.walsh_hadamard.walsh2_matrix" class="sphx-glr-backref-module-spyrit-misc-walsh_hadamard sphx-glr-backref-type-py-function"><span class="n">walsh2_matrix</span></a><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">F</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">Sampling_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
<span class="n">M_xy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">M</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">Sampling_map</span><span class="p">[:,</span> <span class="n">M_xy</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Sampling_map</span><span class="p">[</span><span class="n">M_xy</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># imagesc(Sampling_map, &#39;low-frequency sampling map&#39;)</span>

<span class="n">Perm</span> <span class="o">=</span> <a href="../_autosummary/spyrit.misc.sampling.Permutation_Matrix.html#spyrit.misc.sampling.Permutation_Matrix" title="spyrit.misc.sampling.Permutation_Matrix" class="sphx-glr-backref-module-spyrit-misc-sampling sphx-glr-backref-type-py-function"><span class="n">Permutation_Matrix</span></a><span class="p">(</span><span class="n">Sampling_map</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">Perm</span> <span class="o">@</span> <span class="n">F</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:</span><span class="n">M</span><span class="p">,</span> <span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of the measurement matrix: </span><span class="si">{</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, we instantiate a <a class="reference internal" href="../_autosummary/spyrit.core.meas.Linear.html#spyrit.core.meas.Linear" title="spyrit.core.meas.Linear"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.meas.Linear</span></code></a> measurement operator,
a <a class="reference internal" href="../_autosummary/spyrit.core.noise.NoNoise.html#spyrit.core.noise.NoNoise" title="spyrit.core.noise.NoNoise"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.noise.NoNoise</span></code></a> noise operator for noiseless case,
and a preprocessing measurements operator <a class="reference internal" href="../_autosummary/spyrit.core.prep.DirectPoisson.html#spyrit.core.prep.DirectPoisson" title="spyrit.core.prep.DirectPoisson"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.prep.DirectPoisson</span></code></a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spyrit.core.meas</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.meas.Linear.html#spyrit.core.meas.Linear" title="spyrit.core.meas.Linear" class="sphx-glr-backref-module-spyrit-core-meas sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Linear</span></a>
<span class="kn">from</span> <span class="nn">spyrit.core.noise</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.noise.NoNoise.html#spyrit.core.noise.NoNoise" title="spyrit.core.noise.NoNoise" class="sphx-glr-backref-module-spyrit-core-noise sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">NoNoise</span></a>
<span class="kn">from</span> <span class="nn">spyrit.core.prep</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.prep.DirectPoisson.html#spyrit.core.prep.DirectPoisson" title="spyrit.core.prep.DirectPoisson" class="sphx-glr-backref-module-spyrit-core-prep sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">DirectPoisson</span></a>

<span class="n">meas_op</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.meas.Linear.html#spyrit.core.meas.Linear" title="spyrit.core.meas.Linear" class="sphx-glr-backref-module-spyrit-core-meas sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Linear</span></a><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">pinv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.noise.NoNoise.html#spyrit.core.noise.NoNoise" title="spyrit.core.noise.NoNoise" class="sphx-glr-backref-module-spyrit-core-noise sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">NoNoise</span></a><span class="p">(</span><span class="n">meas_op</span><span class="p">)</span>
<span class="n">N0</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Mean maximum total number of photons</span>
<span class="n">prep</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.prep.DirectPoisson.html#spyrit.core.prep.DirectPoisson" title="spyrit.core.prep.DirectPoisson" class="sphx-glr-backref-module-spyrit-core-prep sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">DirectPoisson</span></a><span class="p">(</span><span class="n">N0</span><span class="p">,</span> <span class="n">meas_op</span><span class="p">)</span>  <span class="c1"># &quot;Undo&quot; the NoNoise operator</span>
</pre></div>
</div>
</section>
<section id="pinvnet-network">
<h2>PinvNet Network<a class="headerlink" href="#pinvnet-network" title="Link to this heading"></a></h2>
<p>We consider the <a class="reference internal" href="../_autosummary/spyrit.core.recon.PinvNet.html#spyrit.core.recon.PinvNet" title="spyrit.core.recon.PinvNet"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.recon.PinvNet</span></code></a> class that reconstructs an
image by computing the pseudoinverse solution and applies a nonlinear
network denoiser. First, we must define the denoiser. As an example,
we choose a small CNN using the <a class="reference internal" href="../_autosummary/spyrit.core.nnet.ConvNet.html#spyrit.core.nnet.ConvNet" title="spyrit.core.nnet.ConvNet"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.nnet.ConvNet</span></code></a> class.
Then, we define the PinvNet network by passing the noise and preprocessing operators
and the denoiser.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spyrit.core.nnet</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.nnet.ConvNet.html#spyrit.core.nnet.ConvNet" title="spyrit.core.nnet.ConvNet" class="sphx-glr-backref-module-spyrit-core-nnet sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ConvNet</span></a>
<span class="kn">from</span> <span class="nn">spyrit.core.recon</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.recon.PinvNet.html#spyrit.core.recon.PinvNet" title="spyrit.core.recon.PinvNet" class="sphx-glr-backref-module-spyrit-core-recon sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">PinvNet</span></a>

<span class="n">denoiser</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.nnet.ConvNet.html#spyrit.core.nnet.ConvNet" title="spyrit.core.nnet.ConvNet" class="sphx-glr-backref-module-spyrit-core-nnet sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ConvNet</span></a><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.recon.PinvNet.html#spyrit.core.recon.PinvNet" title="spyrit.core.recon.PinvNet" class="sphx-glr-backref-module-spyrit-core-recon sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">PinvNet</span></a><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">prep</span><span class="p">,</span> <span class="n">denoi</span><span class="o">=</span><span class="n">denoiser</span><span class="p">)</span>

<span class="c1"># Send to GPU if available</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>

<span class="c1"># Use multiple GPUs if available</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Let&#39;s use&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">(),</span> <span class="s2">&quot;GPUs!&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example provided, we choose a small CNN using the <a class="reference internal" href="../_autosummary/spyrit.core.nnet.ConvNet.html#spyrit.core.nnet.ConvNet" title="spyrit.core.nnet.ConvNet"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.nnet.ConvNet</span></code></a> class.
This can be replaced by any denoiser, for example the <a class="reference internal" href="../_autosummary/spyrit.core.nnet.Unet.html#spyrit.core.nnet.Unet" title="spyrit.core.nnet.Unet"><code class="xref py py-class docutils literal notranslate"><span class="pre">spyrit.core.nnet.Unet</span></code></a> class
or a custom denoiser.</p>
</div>
</section>
<section id="define-a-loss-function-optimizer-and-scheduler">
<h2>Define a Loss function optimizer and scheduler<a class="headerlink" href="#define-a-loss-function-optimizer-and-scheduler" title="Link to this heading"></a></h2>
<p>In order to train the network, we need to define a loss function, an optimizer
and a scheduler. We use the Mean Square Error (MSE) loss function, weigh decay
loss and the Adam optimizer. The scheduler decreases the learning rate
by a factor of <code class="xref py py-attr docutils literal notranslate"><span class="pre">gamma</span></code> every <code class="xref py py-attr docutils literal notranslate"><span class="pre">step_size</span></code> epochs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">lr_scheduler</span>
<span class="kn">from</span> <span class="nn">spyrit.core.train</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.train.save_net.html#spyrit.core.train.save_net" title="spyrit.core.train.save_net" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-function"><span class="n">save_net</span></a><span class="p">,</span> <a href="../_autosummary/spyrit.core.train.Weight_Decay_Loss.html#spyrit.core.train.Weight_Decay_Loss" title="spyrit.core.train.Weight_Decay_Loss" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Weight_Decay_Loss</span></a>

<span class="c1"># Parameters</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="n">criterion</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.train.Weight_Decay_Loss.html#spyrit.core.train.Weight_Decay_Loss" title="spyrit.core.train.Weight_Decay_Loss" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Weight_Decay_Loss</span></a><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="train-the-network">
<h2>Train the network<a class="headerlink" href="#train-the-network" title="Link to this heading"></a></h2>
<p>To train the network, we use the <a class="reference internal" href="../_autosummary/spyrit.core.train.train_model.html#spyrit.core.train.train_model" title="spyrit.core.train.train_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">train_model()</span></code></a> function,
which handles the training process. It iterates through the dataloader, feeds the inputs to the
network and optimizes the solution (by computing the loss and its gradients and
updating the network weights at each iteration). In addition, it computes
the loss and desired metrics on the training and validation sets at each iteration.
The training process can be monitored using Tensorboard.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To launch Tensorboard type in a new console:</p>
<blockquote>
<div><p>tensorboard –logdir runs</p>
</div></blockquote>
<p>and open the provided link in a browser. The training process can be monitored
in real time in the “Scalars” tab. The “Images” tab allows to visualize the
reconstructed images at different iterations <code class="xref py py-attr docutils literal notranslate"><span class="pre">tb_freq</span></code>.</p>
</div>
<p>In order to train, you must set <code class="xref py py-attr docutils literal notranslate"><span class="pre">mode_run</span></code> to True for training. It is set to False
by default to download the pretrained weights and results for display,
as training takes around 40 min for 30 epochs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We train for one epoch only to check that everything works fine.</span>

<span class="kn">from</span> <span class="nn">spyrit.core.train</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.train.train_model.html#spyrit.core.train.train_model" title="spyrit.core.train.train_model" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-function"><span class="n">train_model</span></a>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Parameters</span>
<span class="n">model_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./model&quot;</span><span class="p">)</span>  <span class="c1"># path to model saving files</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of training epochs (num_epochs = 30)</span>
<span class="n">checkpoint_interval</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># interval between saving model checkpoints</span>
<span class="n">tb_freq</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">50</span>  <span class="c1"># interval between logging to Tensorboard (iterations through the dataloader)</span>
<span class="p">)</span>

<span class="c1"># Path for Tensorboard experiment tracking logs</span>
<span class="n">name_run</span> <span class="o">=</span> <span class="s2">&quot;stdl10_hadampos&quot;</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H-%M&quot;</span><span class="p">)</span>
<span class="n">tb_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;runs/runs_</span><span class="si">{</span><span class="n">name_run</span><span class="si">}</span><span class="s2">_n</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">N0</span><span class="p">)</span><span class="si">}</span><span class="s2">_m</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Train the network</span>
<span class="k">if</span> <span class="n">mode_run</span><span class="p">:</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">train_info</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.train.train_model.html#spyrit.core.train.train_model" title="spyrit.core.train.train_model" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-function"><span class="n">train_model</span></a><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">criterion</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="p">,</span>
        <span class="n">dataloaders</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">model_root</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_checkpoint</span><span class="o">=</span><span class="n">checkpoint_interval</span><span class="p">,</span>
        <span class="n">tb_path</span><span class="o">=</span><span class="n">tb_path</span><span class="p">,</span>
        <span class="n">tb_freq</span><span class="o">=</span><span class="n">tb_freq</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">train_info</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="save-the-network-and-training-history">
<h2>Save the network and training history<a class="headerlink" href="#save-the-network-and-training-history" title="Link to this heading"></a></h2>
<p>We save the model so that it can later be utilized. We save the network’s
architecture, the training parameters and the training history.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">spyrit.core.train</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.train.save_net.html#spyrit.core.train.save_net" title="spyrit.core.train.save_net" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-function"><span class="n">save_net</span></a>

<span class="c1"># Training parameters</span>
<span class="n">train_type</span> <span class="o">=</span> <span class="s2">&quot;N0_</span><span class="si">{:g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N0</span><span class="p">)</span>
<span class="n">arch</span> <span class="o">=</span> <span class="s2">&quot;pinv-net&quot;</span>
<span class="n">denoi</span> <span class="o">=</span> <span class="s2">&quot;cnn&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;stl10&quot;</span>
<span class="n">reg</span> <span class="o">=</span> <span class="mf">1e-7</span>  <span class="c1"># Default value</span>
<span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;N_</span><span class="si">{}</span><span class="s2">_M_</span><span class="si">{}</span><span class="s2">_epo_</span><span class="si">{}</span><span class="s2">_lr_</span><span class="si">{}</span><span class="s2">_sss_</span><span class="si">{}</span><span class="s2">_sdr_</span><span class="si">{}</span><span class="s2">_bs_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">batch_size</span>
<span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">model_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">denoi</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">train_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">Path</span><span class="p">(</span><span class="n">model_root</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">checkpoint_interval</span><span class="p">:</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<a href="../_autosummary/spyrit.core.train.save_net.html#spyrit.core.train.save_net" title="spyrit.core.train.save_net" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-function"><span class="n">save_net</span></a><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

<span class="c1"># Save training history</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">if</span> <span class="n">mode_run</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">spyrit.core.train</span> <span class="kn">import</span> <a href="../_autosummary/spyrit.core.train.Train_par.html#spyrit.core.train.Train_par" title="spyrit.core.train.Train_par" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Train_par</span></a>

    <span class="n">params</span> <span class="o">=</span> <a href="../_autosummary/spyrit.core.train.Train_par.html#spyrit.core.train.Train_par" title="spyrit.core.train.Train_par" class="sphx-glr-backref-module-spyrit-core-train sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Train_par</span></a><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">reg</span><span class="p">)</span>
    <span class="n">params</span><span class="o">.</span><span class="n">set_loss</span><span class="p">(</span><span class="n">train_info</span><span class="p">)</span>

    <span class="n">train_path</span> <span class="o">=</span> <span class="n">model_root</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;TRAIN_</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">denoi</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">train_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.pkl&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">param_file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_file</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Download training history</span>
    <span class="kn">import</span> <span class="nn">gdown</span>

    <span class="n">train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">model_root</span><span class="p">,</span>
        <span class="s2">&quot;TRAIN_pinv-net_cnn_stl10_N0_1_N_64_M_1024_epo_30_lr_0.001_sss_10_sdr_0.5_bs_512_reg_1e-07.pkl&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">url_train</span> <span class="o">=</span> <span class="s2">&quot;https://drive.google.com/file/d/13KIbSEigHBZ8ub_JxMUqwRDMHklnFz8A/view?usp=drive_link&quot;</span>
    <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url_train</span><span class="p">,</span> <span class="n">train_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">param_file</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">param_file</span><span class="p">)</span>
    <span class="n">train_info</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">train_loss</span>
    <span class="n">train_info</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">val_loss</span>
</pre></div>
</div>
<p>We plot the training loss and validation loss</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot</span>
<span class="c1"># sphinx_gallery_thumbnail_number = 2</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_info</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_info</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Epochs&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the googlecolab notebook <a class="reference external" href="https://github.com/openspyrit/spyrit-examples/tree/master/tutorial">spyrit-examples/tutorial/tuto_train_lin_meas_colab.ipynb</a>
for training a reconstruction network on GPU. It shows how to train
using different architectures, denoisers and other hyperparameters from
<a class="reference internal" href="../_autosummary/spyrit.core.train.train_model.html#spyrit.core.train.train_model" title="spyrit.core.train.train_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">train_model()</span></code></a> function.</p>
</div>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-gallery-tuto-04-train-pseudoinverse-cnn-linear-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/12e7186c2da1d70aae57eb74f6ed23a0/tuto_04_train_pseudoinverse_cnn_linear.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">tuto_04_train_pseudoinverse_cnn_linear.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/14b1c254a46df1904be73f3ff1dcfbec/tuto_04_train_pseudoinverse_cnn_linear.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">tuto_04_train_pseudoinverse_cnn_linear.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tuto_03_pseudoinverse_cnn_linear.html" class="btn btn-neutral float-left" title="03. Pseudoinverse solution + CNN denoising" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tuto_05_acquisition_split_measurements.html" class="btn btn-neutral float-right" title="05. Acquisition operators (advanced) - Split measurements and subsampling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Antonio Tomas Lorente Mur - Nicolas Ducros - Sebastien Crombez - Thomas Baudier - Romain Phan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
